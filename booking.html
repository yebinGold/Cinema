<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Cinema - 영화 예매</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="header">
        <a href="main.html"><div id="logo">Violet Cinema</div></a>
        <span id="greeting">김예빈님, 환영합니다</span>
        <nav class="nav">
            <ul>
                <li>
                    <a href="main.html">홈</a>
                </li>
                <li>
                    <a href="cinema-info.html">극장 소개</a>
                </li>
                <li>
                    <a href="time-table.html">상영시간표</a>
                </li>
                <li>
                    <a href="#" class="nowpage">영화 예매</a>
                </li>
                <li>
                    <a href="booking-check.html">예매 확인/취소</a>
                </li>
            </ul>
        </nav>
    </div>
    <div class="mainbox">
        <h2 class="title">영화 예매</h2>
        <div class="booking">
            <form action="#" class="booking__part1">
                <div class="film-cbx">
                    <h3 class="subtitle">1. 영화 선택</h3>
                    <div class="film-cbx__film" id="film-cbx__film1" onclick="selectFilm(1);">
                        <label for="film-cbx1">닥터스트레인지2: 대혼돈의 멀티버스</label>
                        <input id="film-cbx1" type="radio" name="film__name">
                    </div>
                    <div class="film-cbx__film" id="film-cbx__film2" onclick="selectFilm(2);">
                        <label for="film-cbx2">스파이더맨: 노 웨이 홈</label>
                        <input id="film-cbx2" type="radio" name="film__name">
                    </div>
                    <div class="film-cbx__film" id="film-cbx__film3" onclick="selectFilm(3);">
                        <label for="film-cbx3">베놈</label>
                        <input id="film-cbx3" type="radio" name="film__name">
                    </div>
                    <div class="film-cbx__film" id="film-cbx__film4" onclick="selectFilm(4);">
                        <label for="film-cbx4">이프 온리</label>
                        <input id="film-cbx4" type="radio" name="film__name">
                    </div>
                    <div class="film-cbx__film" id="film-cbx__film5" onclick="selectFilm(5);">
                        <label for="film-cbx5">리틀 포레스트</label>
                        <input id="film-cbx5" type="radio" name="film__name">
                    </div>
                    <div class="film-cbx__film" id="film-cbx__film6" onclick="selectFilm(6);">
                        <label for="film-cbx6">스타 이즈 본</label>
                        <input id="film-cbx6" type="radio" name="film__name">
                    </div>
                </div> 
                <div class="film-subinfo">
                    <div class="film-date_time">
                        <h3 class="subtitle">2. 날짜 및 상영시간 선택</h3>
                        <input type="date" value="2022-05-22" id="film__date"><br>
                        <select name="film__time" id="film__time1">
                            <option value="4-08:30 ~ 10:36">08:30 ~ 10:36 (4관)</option>
                            <option value="3-15:10 ~ 17:16">15:10 ~ 17:16 (3관)</option>
                            <option value="4-18:28 ~ 20:34">18:28 ~ 20:34 (4관)</option>
                            <option value="3-19:43 ~ 21:49">19:43 ~ 21:49 (3관)</option>
                        </select>
                        <select name="film__time" id="film__time2">
                            <option value="3-09:50 ~ 12:18">09:50 ~ 12:18 (3관)</option>
                            <option value="4-13:11 ~ 15:39">13:11 ~ 15:39 (4관)</option>
                            <option value="4-15:50 ~ 18:18">15:50 ~ 18:18 (4관)</option>
                        </select>
                        <select name="film__time" id="film__time3">
                            <option value="2-12:10 ~ 13:57">12:10 ~ 13:57 (2관)</option>
                            <option value="3-17:36 ~ 19:23">17:36 ~ 19:23 (3관)</option>
                            <option value="2-18:24 ~ 20:11">18:24 ~ 20:11 (2관)</option>
                        </select>
                        <select name="film__time" id="film__time4">
                            <option value="1-08:20 ~ 09:56">08:20 ~ 09:56 (1관)</option>
                            <option value="2-14:25 ~ 16:01">14:25 ~ 16:01 (2관)</option>
                            <option value="2-20:31 ~ 22:07">20:31 ~ 22:07 (2관)</option>
                        </select>
                        <select name="film__time" id="film__time5">
                            <option value="1-10:20 ~ 12:03">10:20 ~ 12:03 (1관)</option>
                            <option value="1-12:35 ~ 14:18">12:35 ~ 14:18 (1관)</option>
                            <option value="2-16:21 ~ 18:04">16:21 ~ 18:04 (2관)</option>
                        </select>
                        <select name="film__time" id="film__time6">
                            <option value="2-09:30 ~ 11:45">09:30 ~ 11:45 (2관)</option>
                            <option value="4-10:56 ~ 13:01">10:56 ~ 13:01 (4관)</option>
                            <option value="3-12:38 ~ 14:53">12:38 ~ 14:53 (3관)</option>
                            <option value="4-20:40 ~ 22:55">20:40 ~ 22:55 (4관)</option>
                        </select>
                    </div>
                    <div class="film-people">
                        <h3 class="subtitle">3. 인원 선택</h3>
                        <label for="teen">청소년: <input id="teen" type="number" min="0" max="10" value="0" size="2">인</label>
                        <label for="adult">일반: <input id="adult" type="number" min="0" max="10" value="0" size="2">인</label>
                    </div>
                    <button class="booking-btn next-btn" type="button" onclick="saveScheduleInfo();">NEXT STEP</button>
                </div>
                
                
            </form>
            <div class="booking__part2">
                <h3>3. 좌석 선택</h3>
                <table border="1" class="seat-table" id="seat-table12">
                    <caption class="table-caption" id="seat-table12__caption">상영관</caption>
                    <tr><th colspan="7">SCREEN</th></tr>
                    <tr><td class="seat" id="A1" onclick="selectSeat('A1');">A1</td><td class="no-seat"></td><td class="seat" id="A2" onclick="selectSeat('A2');">A2</td><td class="seat" id="A3" onclick="selectSeat('A3');">A3</td><td class="seat" id="A4" onclick="selectSeat('A4');">A4</td><td class="no-seat"></td><td class="seat" id="A5" onclick="selectSeat('A5');">A5</td></tr>
                    <tr><td class="seat" id="B1" onclick="selectSeat('B1');">B1</td><td class="no-seat"></td><td class="seat" id="B2" onclick="selectSeat('B2');">B2</td><td class="seat" id="B3" onclick="selectSeat('B3');">B3</td><td class="seat" id="B4" onclick="selectSeat('B4');">B4</td><td class="no-seat"></td><td class="seat" id="B5" onclick="selectSeat('B5');">B5</td></tr>
                    <tr><td class="seat" id="C1" onclick="selectSeat('C1');">C1</td><td class="no-seat"></td><td class="seat" id="C2" onclick="selectSeat('C2');">C2</td><td class="seat" id="C3" onclick="selectSeat('C3');">C3</td><td class="seat" id="C4" onclick="selectSeat('C4');">C4</td><td class="no-seat"></td><td class="seat" id="C5" onclick="selectSeat('C5');">C5</td></tr>
                    <tr><td class="seat" id="D1" onclick="selectSeat('D1');">D1</td><td class="no-seat"></td><td class="seat" id="D2" onclick="selectSeat('D2');">D2</td><td class="seat" id="D3" onclick="selectSeat('D3');">D3</td><td class="seat" id="D4" onclick="selectSeat('D4');">D4</td><td class="no-seat"></td><td class="seat" id="D5" onclick="selectSeat('D5');">D5</td></tr>
                    <tr><td class="seat" id="E1" onclick="selectSeat('E1');">E1</td><td class="no-seat"></td><td class="seat" id="E2" onclick="selectSeat('E2');">E2</td><td class="seat" id="E3" onclick="selectSeat('E3');">E3</td><td class="seat" id="E4" onclick="selectSeat('E4');">E4</td><td class="no-seat"></td><td class="seat" id="E5" onclick="selectSeat('E5');">E5</td></tr>
                    <tr><td class="seat" id="F1" onclick="selectSeat('F1');">F1</td><td class="no-seat"></td><td class="seat" id="F2" onclick="selectSeat('F2');">F2</td><td class="seat" id="F3" onclick="selectSeat('F3');">F3</td><td class="seat" id="F4" onclick="selectSeat('F4');">F4</td><td class="no-seat"></td><td class="seat" id="F5" onclick="selectSeat('F5');">F5</td></tr>
                    
                </table>
                <table border="1" class="seat-table" id="seat-table34">
                    <caption class="table-caption" id="seat-table34__caption">상영관</caption>
                    <tr><th colspan="9">SCREEN</th></tr>
                    <tr><td class="seat" id="c-A1" onclick="selectSeat('c-A1');">A1</td><td class="seat" id="c-A2" onclick="selectSeat('c-A2');">A2</td><td class="no-seat"></td><td class="seat" id="c-A3" onclick="selectSeat('c-A3');">A3</td><td class="seat" id="c-A4" onclick="selectSeat('c-A4');">A4</td><td class="seat" id="c-A5" onclick="selectSeat('c-A5');">A5</td><td class="no-seat"></td><td class="seat" id="c-A6" onclick="selectSeat('c-A6');">A6</td><td class="seat" id="c-A7" onclick="selectSeat('c-A7');">A7</td></tr>
                    <tr><td class="seat" id="c-B1" onclick="selectSeat('c-B1');">B1</td><td class="seat" id="c-B2" onclick="selectSeat('c-B2');">B2</td><td class="no-seat"></td><td class="seat" id="c-B3" onclick="selectSeat('c-B3');">B3</td><td class="seat" id="c-B4" onclick="selectSeat('c-B4');">B4</td><td class="seat" id="c-B5" onclick="selectSeat('c-B5');">B5</td><td class="no-seat"></td><td class="seat" id="c-B6" onclick="selectSeat('c-B6');">B6</td><td class="seat" id="c-B7" onclick="selectSeat('c-B7');">B7</td></tr>
                    <tr><td class="seat" id="c-C1" onclick="selectSeat('c-C1');">C1</td><td class="seat" id="c-C2" onclick="selectSeat('c-C2');">C2</td><td class="no-seat"></td><td class="seat" id="c-C3" onclick="selectSeat('c-C3');">C3</td><td class="seat" id="c-C4" onclick="selectSeat('c-C4');">C4</td><td class="seat" id="c-C5" onclick="selectSeat('c-C5');">C5</td><td class="no-seat"></td><td class="seat" id="c-C6" onclick="selectSeat('c-C6');">C6</td><td class="seat" id="c-C7" onclick="selectSeat('c-C7');">C7</td></tr>
                    <tr><td class="seat" id="c-D1" onclick="selectSeat('c-D1');">D1</td><td class="seat" id="c-D2" onclick="selectSeat('c-D2');">D2</td><td class="no-seat"></td><td class="seat" id="c-D3" onclick="selectSeat('c-D3');">D3</td><td class="seat" id="c-D4" onclick="selectSeat('c-D4');">D4</td><td class="seat" id="c-D5" onclick="selectSeat('c-D5');">D5</td><td class="no-seat"></td><td class="seat" id="c-D6" onclick="selectSeat('c-D6');">D6</td><td class="seat" id="c-D7" onclick="selectSeat('c-D7');">D7</td></tr>
                    <tr><td class="seat" id="c-E1" onclick="selectSeat('c-E1');">E1</td><td class="seat" id="c-E2" onclick="selectSeat('c-E2');">E2</td><td class="no-seat"></td><td class="seat" id="c-E3" onclick="selectSeat('c-E3');">E3</td><td class="seat" id="c-E4" onclick="selectSeat('c-E4');">E4</td><td class="seat" id="c-E5" onclick="selectSeat('c-E5');">E5</td><td class="no-seat"></td><td class="seat" id="c-E6" onclick="selectSeat('c-E6');">E6</td><td class="seat" id="c-E7" onclick="selectSeat('c-E7');">E7</td></tr>
                    <tr><td class="seat" id="c-F1" onclick="selectSeat('c-F1');">F1</td><td class="seat" id="c-F2" onclick="selectSeat('c-F2');">F2</td><td class="no-seat"></td><td class="seat" id="c-F3" onclick="selectSeat('c-F3');">F3</td><td class="seat" id="c-F4" onclick="selectSeat('c-F4');">F4</td><td class="seat" id="c-F5" onclick="selectSeat('c-F5');">F5</td><td class="no-seat"></td><td class="seat" id="c-F6" onclick="selectSeat('c-F6');">F6</td><td class="seat" id="c-F7" onclick="selectSeat('c-F7');">F7</td></tr>
                </table>
                <div id="current-seats">현재 선택 좌석 : </div>
                <button class="booking-btn next-btn" type="button" onclick="confirmBookingInfo();">NEXT STEP</button>
            </div>
            <div class="booking__part3">
                <h3>4. 예매 정보 확인</h3>
                <div>
                    <p id="booking-info"></p>
                    <p id="price-info"></p>
                </div>
                
                <button class="booking-btn next-btn" type="button" onclick="payment();">결제</button>
            </div>
        </div>
        
    </div>

    <script type="text/javascript">
        var selectedFilm; // 선택한 영화
        var selectedDate; // 선택한 날짜 "20xx-xx-xx"
        var combobox; // 드롭박스
        var selectedTime; // 선택한 상영 시간 "00:00 ~ 00:00"
        var selectedRoom; // 선택한 상영관
        var selectedTeen, selectedAdult; // 청소년 / 성인 수
        var selectedPeople; // 전체 인원 수

        var selectedSeats = []; // 선택 좌석 배열
        var price; // 총 결제 가격

        function selectFilm(n){
            combobox = document.getElementById("film__time"+n);
            combobox.style.display = "block";

            for (var i = 1; i <= 6; i++){
                var filmBox = document.getElementById("film-cbx__film"+i);
                var comboes = document.getElementById("film__time"+i);

                if (i == n) {
                    filmBox.style.backgroundColor = "#CAAADB";
                    selectedFilm = filmBox.children[0].innerText;
                }
                else {
                    filmBox.style.backgroundColor = "white";
                    comboes.style.display = "none";
                } 
            }
            var next = document.getElementsByClassName("film-subinfo");
            next[0].style.visibility = "visible";
        }

        function saveScheduleInfo(){
            selectedDate = document.getElementById("film__date").value; // 선택한 날짜 "20xx-xx-xx"
            var time = combobox.value;
            selectedTime = time.substr(2, time.length-2); // 상영 시간 "00:00 ~ 00~00"
            selectedStartTime = selectedTime.substr(0, 5); // 선택한 시작 시간 "00:00"
            selectedRoom = time.slice(0,1); // 선택한 상영관
            selectedTeen = parseInt(document.getElementById("teen").value), selectedAdult = parseInt(document.getElementById("adult").value); // 청소년 / 성인 수
            selectedPeople = selectedTeen + selectedAdult; // 전체 인원 수
            
            if (selectedPeople < 1){
                alert("최소 인원을 선택해주세요!");
            }
            else if (selectedPeople > 10) {
                alert("예매는 한 번에 최대 10명까지만 가능합니다.");
            }
            else{
                var tableId;

                if (selectedRoom <= 2) {
                    tableId = "12";
                }
                else {
                    tableId = "34";
                }

                var next = document.getElementsByClassName("booking__part2");
                var seatTable = document.getElementById("seat-table"+tableId);
                var caption = document.getElementById("seat-table"+tableId+"__caption");

                caption.innerText = "제 " + selectedRoom + " 상영관"
                if (tableId == "12") {
                    seatTable.style.display = "table";
                    document.getElementById("seat-table34").style.display = "none";
                }
                else{
                    seatTable.style.display = "table";
                    document.getElementById("seat-table12").style.display = "none";
                }
                
                updateSeats(seatTable);
                next[0].style.display = "block";
            }
         }

         function updateSeats(table){
            // 같은 날짜/시간/영화 상영 일정에 이미 선택된 좌석 정보 업데이트
            // 예매된 좌석 배열 만들어서
            // 해당 엘리먼트 배경색 바꾸기
            // 만약 배경색==grey인 좌석이 다시 선택되었다면 -> alert "이미 예매된 좌석입니다!"
            var ls = window.localStorage;
            var bookedSeats = [];
            
            for (var i = 0; i < ls.length; i++){
                var book = JSON.parse(ls.getItem(i));
                var date = book["date"];
                var time = book["time"];
                var seats = book["seats"];

                if ((date == selectedDate) && (time == selectedTime)) {
                    bookedSeats = bookedSeats.concat(seats); // 이미 예매된 좌석을 저장한 배열
                }
            }
    
            var tableSeats = table.getElementsByClassName("seat"); // 상영관 내 모든 좌석
            for (var j = 0; j < tableSeats.length; j++) {
                var tableSeat = tableSeats.item(j);
                if (bookedSeats.includes(tableSeat.innerText)){ // 예매된 좌석이면
                    tableSeat.style.backgroundColor = "grey"; // 예매된 좌석임을 표시
                }
                else {
                    tableSeat.style.backgroundColor = "white";
                }
            }
        }
       


         function selectSeat(id){
            var seat = document.getElementById(id);
            var seatNum = seat.innerText;
            
            if (selectedSeats.indexOf(seatNum) != -1) {
                selectedSeats.splice(selectedSeats.indexOf(seatNum), 1); // 제거
                seat.style.backgroundColor = "white";
                seat.style.color = "black";
            }
            else if (seat.style.backgroundColor == "grey"){
                alert("이미 예매가 완료된 좌석입니다!");
            }
            else if (selectedSeats.length >= selectedPeople) {
                alert("더 이상 선택할 수 없습니다!");
            }
            else {
                selectedSeats.push(seatNum);
                seat.style.backgroundColor = "#620482";
                seat.style.color = "white";
                }
            var current = document.getElementById("current-seats");
            var str = "";
            
            for (var i = 0; i < selectedSeats.length; i++) {
                str += selectedSeats[i]+ " ";
            }

            current.innerText = "현재 선택 좌석 : " + str + " (" + selectedSeats.length + "/" + selectedPeople + ")";
         }

         function confirmBookingInfo() {
            if (selectedSeats.length < selectedPeople) {
                alert("좌석 수를 알맞게 선택해주세요!");
            }
            else {
                var next = document.getElementsByClassName("booking__part3");
                next[0].style.display = "block";
            }

            var confirmText = document.getElementById("booking-info");
            var priceText = document.getElementById("price-info"); 

            confirmText.innerHTML = "";
            confirmText.innerHTML += "예매 영화 : " + selectedFilm + "<br>";
            confirmText.innerHTML += "예매 날짜 : " + selectedDate + "<br><br>";
            confirmText.innerHTML += "상영관 : " + selectedRoom + "관<br>";
            confirmText.innerHTML += "상영 시간 : " + selectedTime + "<br><br>";
            confirmText.innerHTML += "선택 인원 : " + selectedPeople + "인 (청소년 " + selectedTeen + ", 일반 " + selectedAdult + ")<br>";
            confirmText.innerHTML += "선택 좌석 : " + selectedSeats.sort() + "<br>";
            

            var teenPrice = 0, adultPrice = 0;
            var addPrice = 0;
            var day = new Date(selectedDate).getDay();

            if (selectedStartTime <= "10:00"){ // 문자열 비교
                teenPrice = 7000;
                adultPrice = 9000;
            }
            else if ((day == 0) || (day == 6)) { // 일요일 or 토요일(주말)
                teenPrice = 10000;
                adultPrice = 12000;
            }
            else {
                teenPrice = 9000;
                adultPrice = 11000;
            }

            if ((selectedRoom == 3) || (selectedRoom == 4)) {
                addPrice = 1000;
            }

            price = (selectedTeen * teenPrice) + (selectedAdult * adultPrice) + addPrice;

            priceText.innerHTML = "";
            priceText.innerHTML += "<h4>결제 가격</h4><br>";
            priceText.innerHTML += "(청소년) " + selectedTeen + " * " + teenPrice + "원 + (일반) " + selectedAdult + " * " + adultPrice + "원<br> + (컴포트관 추가 비용) " + addPrice + "원<br>";
            priceText.innerHTML += "<br>= 총 <strong>" + price + "원</strong>";
         }

         function payment(){
             var pay = confirm("총 "+price+"원 결제하시겠습니까?");

             if (pay) {
                alert("결제가 완료되었습니다.")
                // 웹 스토리지에 데이터 저장
                saveBookingInStorage();
                // 예매 확인 페이지로 이동
                location.href = "booking-check.html";
             }
             else {
                alert("결제가 취소되었습니다.")
                location.href = "main.html";
             }
         }

         function saveBookingInStorage(){
            var ls = window.localStorage;
            var book = {
                film: selectedFilm,
                date: selectedDate,
                room: selectedRoom,
                time: selectedTime,
                ppl: selectedPeople,
                seats: selectedSeats
            }
            ls.setItem(ls.length, JSON.stringify(book));
         }

    </script>

    <footer>
        <span id="logo">Violet Cinema</span>
        <div class="personal-info">
            <p>
                <span>대표</span> 김예빈<br>
                <span>소속</span> 한국외국어대학교 서울캠퍼스<br>
                <span>주소</span> 서울특별시 동대문구 이문로 107
            </p>
        </div>
        <div class="links">
            <a href="https://www.hufs.ac.kr/" target="_blank"><img src="media/hufs.jpeg" alt="hufs"></a>
            <a href="https://www.facebook.com/" target="_blank"><img src="media/facebook.ico" alt="facebook"></a>
            <a href="https://www.instagram.com/" target="_blank"><img src="media/insta.jpeg" alt="instagram"></a>
            <a href="https://www.twitter.com/" target="_blank"><img src="media/twitter.jpeg" alt="twitter"></a>
        </div>
    </footer>

</body>
</html>